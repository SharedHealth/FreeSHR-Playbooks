---
- name: install haproxy
  yum: name={{ item }} state=present
  with_items:
    - haproxy

- name: define proxy config
  template: 
      src=haproxy.j2
      dest=/etc/haproxy/haproxy.cfg
      mode=640
      owner=haproxy
      group=haproxy
      backup=yes

- name: Allow listen access to haproxy http
  iptables: chain=INPUT jump=ACCEPT protocol=tcp  destination_port=80 comment="HAPROXY HTTP"

- name: Allow listen access to haproxy https
  iptables: chain=INPUT jump=ACCEPT protocol=tcp  destination_port=443 comment="HAPROXY HTTPS"

- name: save iptables
  command: service iptables save

- name: copy rsyslog configuration
  template:
    src=haproxy.rsyslog.j2
    dest=/etc/rsyslog.d/haproxy.conf
    backup=yes

- name: enable rsyslog udp server
  lineinfile:
    dest=/etc/rsyslog.conf
    line='$ModLoad imudp'
    state=present

- name: rsyslog udp server configuration
  lineinfile:
    dest=/etc/rsyslog.conf
    line='$UDPServerRun 514'
    state=present

- name: rsyslog udp allow only localhost
  lineinfile:
    dest=/etc/rsyslog.conf
    line='$UDPServerAddress 127.0.0.1'
    insertafter='^\$UDPServerRun'
    state=present

- service: name=rsyslog state=restarted
  
- service: name=haproxy state=restarted enabled=yes

