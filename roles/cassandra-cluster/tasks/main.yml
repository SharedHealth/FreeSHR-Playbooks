- name: Install datastax repo
  copy:
    src=datastax.repo
    dest=/etc/yum.repos.d/datastax.repo
    owner=root group=root mode=0644
  sudo: yes

- name: Install cassandra
  yum: name=dsc20 state=present
  sudo: yes

- name: Downlaod jna
  get_url:
    url={{ cassandra_jna_download_url }}
    dest=/usr/share/cassandra/lib/jna.jar
    owner=cassandra group=cassandra mode=0755

- name: Update security conf for jna
  lineinfile:
    dest: /etc/security/limits.conf
    line: "{{ item.line }}"
  with_items:
    - { line: "* - memlock unlimited" }
    - { line: "* - nofile 100000" }
    - { line: "* - nproc 32768" }
    - { line: "* - as unlimited" }

- name: Register iptable rules
  shell: iptables -L
  register: iptablesrules
  sudo: yes
  tags: iptables

- name: Allow cassandra rpc port through firewall
  command: /sbin/iptables -I INPUT 1 -p tcp --dport 9160 -j ACCEPT -m comment --comment "CassandraRpc"
  sudo: yes
  when: iptablesrules.stdout.find("CassandraRpc") == -1
  tags: iptables

- name: Allow Cassandra inter-node cluster communication
  command: /sbin/iptables -I INPUT 1 -p tcp --dport 7000 -j ACCEPT -m comment --comment "CassandraInterNode"
  sudo: yes
  when: iptablesrules.stdout.find("CassandraInterNode") == -1
  tags: iptables

- name: Allow Cassandra JMX monitoring
  command: /sbin/iptables -I INPUT 1 -p tcp --dport 7199 -j ACCEPT -m comment --comment "CassandraJMX"
  sudo: yes
  when: iptablesrules.stdout.find("CassandraJMX") == -1
  tags: iptables

- name: Allow Cassandra cql native transport
  command: /sbin/iptables -I INPUT 1 -p tcp --dport 9042 -j ACCEPT -m comment --comment "CassandraNative"
  sudo: yes
  when: iptablesrules.stdout.find("CassandraNative") == -1
  tags: iptables

- name: Allow Opscenter monitoring
  command: /sbin/iptables -I INPUT 1 -p tcp --dport 61620 -j ACCEPT -m comment --comment "OpscenterMonitoring"
  sudo: yes
  when: iptablesrules.stdout.find("OpscenterMonitoring") == -1
  tags: iptables


- name: Allow Opscenter agents
  command: /sbin/iptables -I INPUT 1 -p tcp --dport 61621 -j ACCEPT -m comment --comment "OpscenterAgents"
  sudo: yes
  when: iptablesrules.stdout.find("OpscenterAgents") == -1
  tags: iptables

- name: save iptables
  shell: iptables-save > /etc/sysconfig/iptables
  sudo: yes
  tags: iptables

- name: stop cassandra
  service: name=cassandra state=stopped
  sudo: yes

- name: delete system data
  command: rm -rf /var/lib/cassandra/data/system/*
  sudo: yes
  
- name: copy config
  template: src=cassandra.yaml dest=/etc/cassandra/conf/
  sudo: yes
  tags:
    - copy-config


- name: allow cassandra user to write to commitlog
  file:
    path={{ cassandra_commit_log_dir }}
    owner=cassandra
    group=cassandra
    follow=yes
    recurse=yes
    state=directory
    
 # - name: set hostname/ip for JMX
 #   lineinfile: dest=/etc/cassandra/conf/cassandra-env.sh regexp='hostname' line='JVM_OPTS="$JVM_OPTS -Djava.rmi.server.hostname={{ inventory_hostname }}"' backup=yes
 #   sudo: yes

- name: install system monitoring tools
  yum: name={{ item }} state=present
  with_items:
    - dstat
  
- name: start cassandra
  service: name=cassandra state=started enabled=yes

- name: Pause for Cassandra to start up
  pause: seconds=60

- name: copy cassandra user credentials change script
  template:
    src=cassandra_users.cql dest=/tmp/cassandra_users.cql
    mode=0644

- name: execute change cassandra user credentials script
  shell: "cqlsh {{ groups['cassandra_seed_node'][0] }} -u cassandra -p {{ cassandra_old_admin_pass }} -f /tmp/cassandra_users.cql"
  register: command_result
  
