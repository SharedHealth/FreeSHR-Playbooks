---
- name: Clean existing
  file: path=/tmp/identity-server.rpm state=absent

- name: Copy rpm
  copy: src={{ rpm }} dest=/tmp/identity-server.rpm mode=0755

- name: Remove identity-server
  yum: name=identity-server.noarch state=absent

- name: Install identity-server
  yum: name=/tmp/identity-server.rpm state=present

- name: Allow app dir access to run user
  file:
    path=/opt/identity-server/
    owner={{ sharedhealth_user }}
    group={{ sharedhealth_group }}
    follow=yes
    recurse=yes
    state=directory
    mode=0750


- name: Allow log dir access to run user
  file:
    path=/opt/identity-server/
    owner={{ sharedhealth_user }}
    group={{ sharedhealth_group }}
    follow=yes
    recurse=yes
    state=directory
    mode=0750

- name: Copy identity-server properties
  template: src=identity-server
    dest=/etc/default/identity-server
    mode=0755
    owner={{ sharedhealth_user }}
    group={{ sharedhealth_group }}

- name: Permissions to service identity-server
  file:
    path=/etc/init.d/identity-server
    src=/opt/identity-server/bin/identity-server
    owner={{ sharedhealth_user }}
    group={{ sharedhealth_group }}
    state=link
    mode=0755

- name: Permissions to var run
  file:
    path=/var/run/identity-server
    src=/opt/identity-server/var
    owner={{ sharedhealth_user }}
    group={{ sharedhealth_group }}
    state=link
    mode=0755

- name: Allow idp port through firewall
  iptables: chain=INPUT jump=ACCEPT protocol=tcp  destination_port={{ idp_port }} comment=IDENTITY-SERVER

- name: save iptables
  command: service iptables save

- name: Restart identity-server
  service: name=identity-server state=restarted enabled=yes
